
networks:
  inception_network:

services:
  
  nginx:
    container_name: nginx
    build: ./requirements/nginx
    restart: always
    networks: 
      - inception_network
    depends_on:
      - wordpress
    volumes:
      - wordpress_volume:/var/www/html
    secrets:
      - db_password
      - db_root_password
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME}
    ports:
      - '443:443'
    expose:
      - '443'

  mariadb:
    container_name: mariadb
    build: ./requirements/mariadb
    volumes:
      - mariadb_volume:/var/lib/mysql   #/var/lib/mysql is the default directory inside a MariaDB container, it's where the database software stores all of its data
                                        #this line tells Docker that you want to bind mount the /home/rgiambon/data/mysql directory on your host to /var/lib/mysql inside the container.
    secrets:
      - db_password
      - db_root_password  # mount the secret into the container
    networks: 
      - inception_network
    restart: always
    env_file:
      - .env

  wordpress:
    container_name: wordpress
    #create a depedency between the 2 container, db will be launched before
    depends_on:
      - mariadb
    build: ./requirements/wordpress
    environment:
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/db_root_password
      - MYSQL_PASSWORD_FILE=/run/secrets/db_password
      - WORDPRESS_DB_NAME=${MYSQL_DATABASE}
      - WORDPRESS_DB_USER=${MYSQL_USER}
      - WORDPRESS_DB_HOST=mariadb:3306
      - WORDPRESS_DB_CHARSET=utf8
      - WORDPRESS_DB_COLLATE=
      - DOMAIN_NAME=${DOMAIN_NAME}
      - WP_ADMIN_USER=${WP_ADMIN_USER}
      - WP_ADMIN_EMAIL=${WP_ADMIN_EMAIL}
      - WP_ADMIN_PASSWORD=${WP_ADMIN_PASSWORD}
      - WP_USER=${WP_USER}
      - WP_USER_EMAIL=${WP_USER_EMAIL}
      - WP_USER_PASSWORD=${WP_USER_PASSWORD}
      - WP_SITE_URL=https://${DOMAIN_NAME}
      - WP_AUTH_KEY=${WP_AUTH_KEY}
      - WP_SECURE_AUTH_KEY=${WP_SECURE_AUTH_KEY}
      - WP_LOGGED_IN_KEY=${WP_LOGGED_IN_KEY}
      - WP_NONCE_KEY=${WP_NONCE_KEY}
      - WP_AUTH_SALT=${WP_AUTH_SALT}
      - WP_SECURE_AUTH_SALT=${WP_SECURE_AUTH_SALT}
      - WP_LOGGED_IN_SALT=${WP_LOGGED_IN_SALT}
      - WP_NONCE_SALT=${WP_NONCE_SALT}
    secrets:
      - db_password
      - db_root_password
    volumes:
      - wordpress_volume:/var/www/html
    networks:
      - inception_network
    restart: always

secrets:
  db_password:
    file: ../secrets/db_password.txt
  db_root_password:
    file: ../secrets/db_root_password.txt

volumes:
  
  mariadb_volume:
    driver: local    #local storage on your host machine
    driver_opts:     #additional details about how Docker should handle these volumes
      type: none     #This tells Docker that you're not creating a new Docker-managed volume, but instead you want to link to existing directories on your host machine
      device: /Users/nemo/data/mysql #/home/rgiambon/data/mysql  #the actual path on your host machine where the data should be stored
      o: bind        #This tells Docker to bind mount these directories. This means the data will be shared between the container and your host machine, so any change in the container will reflect on the host, and vice versa.
  
  wordpress_volume:
    driver: local
    driver_opts:
      type: none
      device: /Users/nemo/data/wordpress #/home/rgiambon/data/wordpress #I will have to create this directory 
      o: bind
